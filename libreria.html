<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Diccionario Pro - PUMUCHORDS</title>
    <style>
        :root { --bg-color: #2c3e50; --accent: #e67e22; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: white; padding: 20px; text-align: center; margin: 0; }
        
        /* Filtros */
        .filters { background: #34495e; padding: 20px; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .filter-group { display: flex; flex-direction: column; align-items: flex-start; }
        label { font-size: 10px; text-transform: uppercase; opacity: 0.7; margin-bottom: 5px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 20px; padding: 10px; }
        
        .chord-box { 
            background: var(--card-bg); border-radius: 8px; padding: 15px; color: #333; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); cursor: pointer;
            position: relative; z-index: 1;
        }

        .chord-name { font-weight: 800; font-size: 18px; color: var(--accent); border-bottom: 2px solid #eee; margin-bottom: 10px; padding-bottom: 5px; }
        .chord-fret-str { font-family: monospace; font-size: 10px; color: #7f8c8d; margin-top: 8px; background: #eee; padding: 2px; border-radius: 3px; }

        /* Zoom */
        .chord-box.expanded {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(2.2);
            z-index: 1000; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; z-index: 999;
            backdrop-filter: blur(3px);
        }

        select { padding: 8px 12px; border-radius: 5px; background: #2c3e50; color: white; border: 1px solid var(--accent); font-weight: bold; }
        .btn-back { display: inline-block; margin-bottom: 20px; color: white; text-decoration: none; border: 1px solid white; padding: 8px 15px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="overlay"></div>
    <a href="index.html" class="btn-back">← Volver al Generador</a>
    <h1>Diccionario de Acordes</h1>

    <div class="filters">
        <div class="filter-group">
            <label>Nota Raíz</label>
            <select id="rootFilter"><option value="ALL">Todas</option></select>
        </div>
        <div class="filter-group">
            <label>Tipo</label>
            <select id="typeFilter"><option value="ALL">Todos</option></select>
        </div>
        <div style="align-self: flex-end; font-size: 11px; opacity: 0.6; padding-bottom: 10px;">
            Haz clic para ampliar y escuchar
        </div>
    </div>

    <div id="chordGrid" class="grid"></div>

    <script>
        const notes = ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si'];
        // Frecuencias base de las cuerdas al aire (E2, A2, D3, G3, B3, E4)
        const stringBaseFreqs = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];
        let libreriaManual = null;
        let audioCtx = null;

        async function cargarLibreria() {
            try {
                const res = await fetch('Acordes2.json');
                libreriaManual = await res.json();
                poblarFiltros();
                render();
            } catch (e) { console.error("Error al cargar JSON"); }
        }

        // --- MOTOR DE AUDIO ---
        function playChord(fretStr) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const frets = fretStr.split('-');
            const now = audioCtx.currentTime;

            frets.forEach((fret, i) => {
                if (fret.toLowerCase() === 'x') return;
                
                const f = parseInt(fret);
                // Calcular frecuencia: freq = base * 2^(traste/12)
                const freq = stringBaseFreqs[i] * Math.pow(2, f / 12);
                
                // Sintetizador simple de cuerda
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = 'triangle'; // Sonido más suave que 'sawtooth'
                osc.frequency.setValueAtTime(freq, now);
                
                gain.gain.setValueAtTime(0.3, now + (i * 0.05)); // Rasgueo progresivo
                gain.gain.exponentialRampToValueAtTime(0.0001, now + 1.5);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.start(now + (i * 0.05));
                osc.stop(now + 1.5);
            });
        }

        function poblarFiltros() {
            const rootSel = document.getElementById('rootFilter');
            const typeSel = document.getElementById('typeFilter');
            notes.forEach(n => rootSel.innerHTML += `<option value="${n}">${n}</option>`);
            Object.keys(libreriaManual).forEach(t => {
                typeSel.innerHTML += `<option value="${t}">${t}</option>`;
            });
            rootSel.onchange = render;
            typeSel.onchange = render;
        }

        function render() {
            const grid = document.getElementById('chordGrid');
            const rootVal = document.getElementById('rootFilter').value;
            const typeVal = document.getElementById('typeFilter').value;
            grid.innerHTML = "";

            for (let typeKey in libreriaManual) {
                if (typeVal !== "ALL" && typeVal !== typeKey) continue;
                for (let noteKey in libreriaManual[typeKey]) {
                    if (rootVal !== "ALL" && rootVal !== noteKey) continue;

                    libreriaManual[typeKey][noteKey].forEach(pos => {
                        let displayType = typeKey === "M" ? "" : typeKey;
                        const card = document.createElement('div');
                        card.className = "chord-box";
                        card.innerHTML = `
                            <div class="chord-name">${noteKey}${displayType}</div>
                            ${drawSVG(pos.split('-'))}
                            <div class="chord-fret-str">${pos}</div>
                        `;
                        
                        card.onclick = (e) => {
                            e.stopPropagation();
                            const isExpanded = card.classList.contains('expanded');
                            document.querySelectorAll('.chord-box').forEach(c => c.classList.remove('expanded'));
                            
                            if (!isExpanded) {
                                card.classList.add('expanded');
                                document.getElementById('overlay').style.display = 'block';
                                playChord(pos); // <-- AQUÍ SUENA EL ACORDE
                            } else {
                                document.getElementById('overlay').style.display = 'none';
                            }
                        };
                        grid.appendChild(card);
                    });
                }
            }
        }

        document.getElementById('overlay').onclick = () => {
            document.querySelectorAll('.chord-box').forEach(c => c.classList.remove('expanded'));
            document.getElementById('overlay').style.display = 'none';
        };

        function drawSVG(frets) {
            const numeric = frets.filter(f => f.toLowerCase() !== 'x').map(f => parseInt(f));
            const pressedFrets = numeric.filter(f => f > 0);
            let startFret = pressedFrets.length > 0 ? Math.min(...pressedFrets) : 1;
            let svg = `<svg width="80" height="100" viewBox="0 0 120 130">
                <text x="5" y="45" font-size="16" fill="#e67e22" font-weight="bold">${startFret}</text>
                <rect x="35" y="25" width="60" height="80" fill="none" stroke="#333" stroke-width="2"/>
                ${[45,65,85].map(y => `<line x1="35" y1="${y}" x2="95" y2="${y}" stroke="#ccc"/>`).join('')}
                ${[35,47,59,71,83,95].map(x => `<line x1="${x}" y1="25" x2="${x}" y2="105" stroke="#333"/>`).join('')}`;
            frets.forEach((f, i) => {
                const x = 35 + (i * 12);
                if (f.toLowerCase() === 'x') svg += `<text x="${x-4}" y="18" font-size="12" fill="red">×</text>`;
                else if (f == '0') svg += `<circle cx="${x}" cy="15" r="4" fill="none" stroke="green"/>`;
                else {
                    const y = 25 + ((parseInt(f) - startFret + 1) * 20) - 10;
                    if (y >= 25 && y <= 105) svg += `<circle cx="${x}" cy="${y}" r="7" fill="#333"/>`;
                }
            });
            return svg + "</svg>";
        }

        cargarLibreria();
    </script>
</body>
</html>
